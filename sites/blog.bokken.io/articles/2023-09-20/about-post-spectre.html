<!DOCTYPE html>
<html lang="ja">
  <head
    prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"
  >
    <meta charset="utf-8" />
    <title>
      Post Spectre 時代の Web のセキュリティについて - Post-Spectre Web
      Development とは | blog.bokken.io
    </title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="この記事では、「Post-Spectre Web Development」 というドキュメントを元に、Spectre 以後の Web 開発において、必要なセキュリティ関連の仕組みやヘッダの設定と、Spectre 以後に新しく策定されたヘッダや仕組みについてまとめる。ボトムアップに説明が続くため、セキュリティヘッダの設定とその理由のみを見たい場合はこちらの節を参照して頂きたい。Spectre は Web の脅威モデルをすっかり変えてしまった。そのように言われてから 5 年ほど経った。これまでは Same Origin Policy と呼ばれる、Origin ごとにリソースの認可を制御することでリソ"
    />
    <meta name="author" content="bokken" />
    <link rel="shortcut icon" href=/assets/img/favicon.ico />
    <link rel="author" href="humans.txt" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@bokken_" />
    <meta name="twitter:creator" content="@bokken_" />
    <meta
      name="twitter:image"
      content="https://bokken.io/assets/img/icon.png"
    />
    <!-- ogp -->
    <meta
      property="og:url"
      content="https://blog.bokken.io/articles/2023-09-20/about-post-spectre.html"
    />
    <meta property="og:type" content="article" />
    <meta
      property="og:title"
      content="Post Spectre 時代の Web のセキュリティについて - Post-Spectre Web Development とは"
    />
    <meta
      property="og:description"
      content="この記事では、「Post-Spectre Web Development」 というドキュメントを元に、Spectre 以後の Web 開発において、必要なセキュリティ関連の仕組みやヘッダの設定と、Spectre 以後に新しく策定されたヘッダや仕組みについてまとめる。ボトムアップに説明が続くため、セキュリティヘッダの設定とその理由のみを見たい場合はこちらの節を参照して頂きたい。Spectre は Web の脅威モデルをすっかり変えてしまった。そのように言われてから 5 年ほど経った。これまでは Same Origin Policy と呼ばれる、Origin ごとにリソースの認可を制御することでリソ"
    />
    <meta property="og:site_name" content="blog.bokken.io" />
    <meta property="og:image" content="https://bokken.io/assets/img/icon.png" />
    <script defer src="/assets/js/img-viewer.js"></script>

    <!-- Twitter -->
    <script
      async
      src="https://platform.twitter.com/widgets.js"
      charset="utf-8"
    ></script>
    <!-- prettier-ignore -->
    <script>
      !(function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } })(document, 'script', 'twitter-wjs');
    </script>

    <link rel=stylesheet type=text/css href=/assets/css/main.css>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css"
    />
  </head>

  <body>
    <header>
      <a href="http://bokken.io">bokken.io</a>
      <nav>
        <ul>
          <li><a href="https://blog.bokken.io">Blog</a></li>
          <li><a href="https://x.bokken.io">Exp</a></li>
          <li><a href="https://blog.bokken.io/feeds/atom.xml">RSS</a></li>
        </ul>
      </nav>
    </header>

    <ul id="bread">
      <li><a href="https://bokken.io" bokken.io>bokken.io</a></li>
      <li><a href="https://blog.bokken.io">blog</a></li>
      <li>
        <a
          href="https://blog.bokken.io/articles/2023-09-20/about-post-spectre.html"
          >Post Spectre 時代の Web のセキュリティについて - Post-Spectre Web
          Development とは</a
        >
      </li>
    </ul>

    <main>
      <article>
        <div id="blog-info">
          <dt>作成日</dt>
          <dd>2023-08-31</dd>
          <dt>更新日</dt>
          <dd>2023-08-31</dd>
          <dt>author</dt>
          <dd><a href="https://twitter.com/bokken_">@bokken_</a></dd>
          <dt>tag</dt>
          <dd>
            <img
              id="article-tag"
              src="https://blog.bokken.io/assets/img/tag.webp"
              height="20"
            />
            security, spectre
          </dd>
        </div>
        <h1>
          <a
            name="post-spectre-時代の-web-のセキュリティについて---post-spectre-web-development-とは"
            href="#post-spectre-時代の-web-のセキュリティについて---post-spectre-web-development-とは"
            id="post-spectre-時代の-web-のセキュリティについて---post-spectre-web-development-とは"
          >
            Post Spectre 時代の Web のセキュリティについて - Post-Spectre Web
            Development とは
          </a>
        </h1>
        <h2>
          <a name="はじめに" href="#はじめに" id="はじめに"> はじめに </a>
        </h2>
        <p id="paragraph-1" class="paragraph">
          この記事では、「<a
            target="_blank"
            rel="noopener"
            href="https://www.w3.org/TR/post-spectre-webdev/"
            >Post-Spectre Web Development</a
          >」 というドキュメントを元に、Spectre 以後の Web
          開発において、必要なセキュリティ関連の仕組みやヘッダの設定と、Spectre
          以後に新しく策定されたヘッダや仕組みについてまとめる。<a
            href="#paragraph-1"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-2" class="paragraph">
          ボトムアップに説明が続くため、セキュリティヘッダの設定とその理由のみを見たい場合は<a
            href="#post-spectre-%E9%96%8B%E7%99%BA%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E9%96%A2%E9%80%A3%E3%81%AE%E3%83%98%E3%83%83%E3%83%80%E3%81%AE%E8%A8%AD%E5%AE%9A"
            >こちらの節</a
          >を参照して頂きたい。<a href="#paragraph-2" class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h2>もくじ</h2>
        <details>
          <summary>(click で開く)</summary>
          <!-- vim-markdown-toc Marked -->

          <ul>
            <li>
              <a href="#spectre-によって変わった-web"
                >Spectre によって変わった Web</a
              >
            </li>
            <li>
              <a href="#セキュリティ関連の仕組みやヘッダ"
                >セキュリティ関連の仕組みやヘッダ</a
              >
              <ul>
                <li>
                  <a
                    href="#spectre-以前から存在するセキュリティ関連の仕組み・ヘッダ"
                    >Spectre 以前から存在するセキュリティ関連の仕組み・ヘッダ</a
                  >
                </li>
                <li>
                  <a
                    href="#spectre-以後に登場したセキュリティ関連の仕組み・ヘッダ"
                    >Spectre 以後に登場したセキュリティ関連の仕組み・ヘッダ</a
                  >
                </li>
                <li>
                  <a href="#cross-origin-opener-policy-(coop)"
                    >Cross Origin Opener Policy (COOP)</a
                  >
                </li>
                <li>
                  <a href="#cross-origin-resource-policy-(corp)"
                    >Cross Origin Resource Policy (CORP)</a
                  >
                </li>
                <li>
                  <a href="#cross-origin-embedder-policy-(coep)"
                    >Cross Origin Embedder Policy (COEP)</a
                  >
                </li>
                <li>
                  <a
                    href="#cross-origin-read-blocking-(corb)-/-opaque-response-blocking-(orb)"
                    >Cross Origin Read Blocking (CORB) / Opaque Response
                    Blocking (ORB)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#post-spectre-開発におけるセキュリティ関連のヘッダの設定"
                >Post-Spectre 開発におけるセキュリティ関連のヘッダの設定</a
              >
              <ul>
                <li>
                  <a href="#a.-サブリソース">A. サブリソース</a>
                  <ul>
                    <li>
                      <a href="#a.1.-静的サブリソース">A.1. 静的サブリソース</a>
                    </li>
                    <li>
                      <a href="#a.2.-動的サブリソース">A.2. 動的サブリソース</a>
                      <ul>
                        <li>
                          <a href="#a.2.1.-アプリケーションの内部レスポンス"
                            >A.2.1. アプリケーションの内部レスポンス</a
                          >
                        </li>
                        <li>
                          <a
                            href="#a.2.1-パーソナライズされた-cross-origin-で使われるリソース"
                            >A.2.1 パーソナライズされた cross-origin
                            で使われるリソース</a
                          >
                        </li>
                        <li>
                          <a
                            href="#a.2.2-cross-origin-に-no-cors-で読み込むリソース"
                            >A.2.2 cross-origin に no-cors で読み込むリソース</a
                          >
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li>
                  <a href="#b.-ドキュメント">B. ドキュメント</a>
                  <ul>
                    <li>
                      <a href="#b.1.-fully-isolated-なドキュメント"
                        >B.1. Fully-Isolated なドキュメント</a
                      >
                    </li>
                    <li>
                      <a
                        href="#b.2.-cross-origin-の-window-から開かれるドキュメント"
                        >B.2. cross-origin の window から開かれるドキュメント</a
                      >
                    </li>
                    <li>
                      <a
                        href="#b.3.-cross-origin-の-opener-から開かれるドキュメント"
                        >B.3. cross-origin の opener から開かれるドキュメント</a
                      >
                      <ul>
                        <li>
                          <a
                            href="#b.3.1-cross-origin-のポップアップで開かれるドキュメント"
                            >B.3.1 cross-origin
                            のポップアップで開かれるドキュメント</a
                          >
                        </li>
                        <li>
                          <a
                            href="#b.3.2-cross-origin-の-frame-に読み込まれるドキュメント"
                            >B.3.2 cross-origin の frame
                            に読み込まれるドキュメント</a
                          >
                        </li>
                        <li>
                          <a
                            href="#b.3.3-cross-origin-のポップアップと-frame-の両方をサポートするドキュメント"
                            >B.3.3 cross-origin のポップアップと frame
                            の両方をサポートするドキュメント</a
                          >
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
            <li>
              <a href="#その他のセキュリティのための取り組み"
                >その他のセキュリティのための取り組み</a
              >
              <ul>
                <li>
                  <a href="#chromeチームによる意思決定"
                    >Chromeチームによる意思決定</a
                  >
                </li>
                <li><a href="#credentialless">credentialless</a></li>
                <li>
                  <a href="#デフォルトの挙動をどうするのか"
                    >デフォルトの挙動をどうするのか</a
                  >
                </li>
              </ul>
            </li>
            <li><a href="#おわりに">おわりに</a></li>
            <li><a href="#参考リンク">参考リンク</a></li>
          </ul>
          <!-- vim-markdown-toc -->
        </details>
        <h2>
          <a
            name="spectre-によって変わった-web"
            href="#spectre-によって変わった-web"
            id="spectre-によって変わった-web"
          >
            Spectre によって変わった Web
          </a>
        </h2>
        <p id="paragraph-3" class="paragraph">
          Spectre は Web
          の脅威モデルをすっかり変えてしまった。そのように言われてから 5
          年ほど経った。<a href="#paragraph-3" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-4" class="paragraph">
          これまでは Same Origin Policy と呼ばれる、Origin
          ごとにリソースの認可を制御することでリソースを守ろうとしてきた。しかし、Spectre
          によって<strong>同一プロセスのメモリ上にデータが展開されるだけで危険</strong>な状態になってしまった。<a
            href="#paragraph-4"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-5" class="paragraph">
          Web
          は他のオリジンのリソースをドキュメントに読み込んでコンテンツを作ることができる。その性質上、同一のプロセスのメモリ上にデータを保持する実装となっていることが多かった。<a
            href="#paragraph-5"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-6" class="paragraph">
          Spectre は CPU の脆弱性を利用した攻撃なため、「CPU
          ベンダが修正を施して Spectre を再現できなくなったときに Web
          は元に戻るのか」、というとそうではない。<a
            href="#paragraph-6"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-7" class="paragraph">
          Spectre
          以外であっても、同一プロセス上のメモリを読む攻撃が見つかるかもしれない。Spectre
          は Web
          の脅威モデルをすっかり変えて、不可逆のものにしてしまった。つまり、Spectre
          を期に追加された様々なセキュリティ関連のヘッダや、HTML
          タグの属性を無視して過ごすことはできない。<a
            href="#paragraph-7"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h2>
          <a
            name="セキュリティ関連の仕組みやヘッダ"
            href="#セキュリティ関連の仕組みやヘッダ"
            id="セキュリティ関連の仕組みやヘッダ"
          >
            セキュリティ関連の仕組みやヘッダ
          </a>
        </h2>
        <p id="paragraph-8" class="paragraph">
          Spectre
          以後、ブラウザがドキュメントを読み込み、そのドキュメント内にある
          cross-origin
          のリソースを読み込むのには一層の注意が払われるようになった。<a
            href="#paragraph-8"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-9" class="paragraph">
          ブラウザがドキュメントを読み込み、cross-origin
          のリソースを読み込む可能性がある部分は下記のようなところがある。<a
            href="#paragraph-9"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-10" class="paragraph">
          <a href="./img/cross-origin.png" rel="noopener"
            ><img src="./img/cross-origin.png" /></a
          ><a href="#paragraph-10" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-11" class="paragraph">
          これらのすべてについて、意図せず cross-origin
          にリソースが読み込まれるのを防がなければいけない。<a
            href="#paragraph-11"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h3>
          <a
            name="spectre-以前から存在するセキュリティ関連の仕組み・ヘッダ"
            href="#spectre-以前から存在するセキュリティ関連の仕組み・ヘッダ"
            id="spectre-以前から存在するセキュリティ関連の仕組み・ヘッダ"
          >
            Spectre 以前から存在するセキュリティ関連の仕組み・ヘッダ
          </a>
        </h3>
        <p id="paragraph-12" class="paragraph">
          Spectre 以前からも、下記のような仕組みやヘッダが存在している。<a
            href="#paragraph-12"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <ul>
          <li>
            <strong>Cross Origin Resource Sharing (CORS)</strong>
            <ul>
              <li>
                サイト A (a.example.com) から cross-origin のサイト B
                (b.example.net) にあるリソースを使いたいときに、サイト B
                のリソースがどの origin で使えるのか制御するための仕組み
              </li>
              <li>
                <code>Access-Control-Allow-Origin</code>
                や、<code>Access-Control-Allow-Methods</code>、<code
                  >Access-Control-Allow-Headers</code
                >
                などのヘッダを返すことで、サイト B
                のリソースに対してアクセスできる origin
                や、実行できるメソッド、使えるヘッダなどを指定できる。
              </li>
              <li>
                厳密にはもう少し色々あるので別の CORS
                に関するサイトやドキュメントを参照していただきたい
              </li>
              <li>
                <font color="red"
                  >no-cors とはどういうことかについて説明したい</font
                >
              </li>
            </ul>
          </li>
          <li>
            <strong>X-Content-Type-Options</strong>
            <ul>
              <li>
                <code>nosniff</code> を指定することで、リクエストの利用先が
                style や script のときに Content-Type が style や script
                のものでないときに、リクエストがブロックされるようになる
                <ul>
                  <li>
                    <font color="red"
                      >これはどういう理由で使うべきなのか補足する。ORB
                      との関連も含めて</font
                    >
                  </li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            <strong>X-Frame-Options</strong>
            <ul>
              <li>
                <code>&lt;frame&gt;</code> や <code>&lt;iframe&gt;</code>、
                <code>&lt;embed&gt;</code>、
                <code>&lt;object&gt;</code>
                といった外部コンテンツを組み込むことができる要素に対して、読み込みを許可するかどうかを指定できる
              </li>
              <li>
                X-Frame-Options の値としては <code>DENY</code> か
                <code>SAMEORIGIN</code> を指定できる。<code
                  >ALLOW-FROM &lt;origin&gt;</code
                >
                も存在していたが、現在では使われておらず、代わりに
                Content-Security-Policy の frame-ancestors を使う
              </li>
              <li>
                Click ジャッキングを防ぐことができる他、意図しない cross-origin
                に frame として読み込まれることを防ぐことができる
                <ul>
                  <li>
                    <a
                      target="_blank"
                      rel="noopener"
                      href="https://www.chromium.org/developers/design-documents/oop-iframes/"
                      >Out-of-Process iframes (OOPIFs)</a
                    >
                    といった frame
                    のプロセスを分離する仕組みが無いブラウザの場合、同一プロセスのメモリに展開されるので攻撃対象になる危険性があるため、指定によって危険性を低減できる
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <p id="paragraph-13" class="paragraph">
          これらは Spectre
          以後も有効な仕組み・ヘッダである。これらの仕組みやヘッダで防げているのは次の図の部分である。<a
            href="#paragraph-13"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-14" class="paragraph">
          <a href="https://placehold.jp/300x300.jpg" rel="noopener"
            ><img src="https://placehold.jp/300x300.jpg" /></a
          ><a href="#paragraph-14" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-15" class="paragraph">
          しかし、これらの仕組みやヘッダだけではカバーできなかった範囲がある。それを次節のような仕組みやヘッダで守るようになった。<a
            href="#paragraph-15"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h3>
          <a
            name="spectre-以後に登場したセキュリティ関連の仕組み・ヘッダ"
            href="#spectre-以後に登場したセキュリティ関連の仕組み・ヘッダ"
            id="spectre-以後に登場したセキュリティ関連の仕組み・ヘッダ"
          >
            Spectre 以後に登場したセキュリティ関連の仕組み・ヘッダ
          </a>
        </h3>
        <p id="paragraph-16" class="paragraph">
          Spectre
          以後に登場したセキュリティ関連の仕組み・ヘッダは下記のようなものがある。<a
            href="#paragraph-16"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <ul>
          <li>Cross Origin Opener Policy (COOP)</li>
          <li>Cross Origin Resource Policy (CORP)</li>
          <li>Cross Origin Embedder Policy (COEP)</li>
          <li>
            Cross Origin Read Blocking (CORB) / Opaque Response Blocking (ORB)
          </li>
        </ul>
        <p id="paragraph-17" class="paragraph">
          それぞれについて簡単に説明する。<a
            href="#paragraph-17"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h3>
          <a
            name="cross-origin-opener-policy-(coop)"
            href="#cross-origin-opener-policy-(coop)"
            id="cross-origin-opener-policy-(coop)"
          >
            Cross Origin Opener Policy (COOP)
          </a>
        </h3>
        <p id="paragraph-18" class="paragraph">
          <a href="https://placehold.jp/300x300.jpg" rel="noopener"
            ><img src="https://placehold.jp/300x300.jpg" /></a
          ><a href="#paragraph-18" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-19" class="paragraph">
          <font color="red">Openerの話</font> Opener の話。<a
            href="#paragraph-19"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h3>
          <a
            name="cross-origin-resource-policy-(corp)"
            href="#cross-origin-resource-policy-(corp)"
            id="cross-origin-resource-policy-(corp)"
          >
            Cross Origin Resource Policy (CORP)
          </a>
        </h3>
        <p id="paragraph-20" class="paragraph">
          <font color="red">Resourceの話</font
          ><a href="#paragraph-20" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-21" class="paragraph">
          <a href="https://placehold.jp/300x300.jpg" rel="noopener"
            ><img src="https://placehold.jp/300x300.jpg" /></a
          ><a href="#paragraph-21" class="paragraph-anchor">¶</a>
        </p>
        <h3>
          <a
            name="cross-origin-embedder-policy-(coep)"
            href="#cross-origin-embedder-policy-(coep)"
            id="cross-origin-embedder-policy-(coep)"
          >
            Cross Origin Embedder Policy (COEP)
          </a>
        </h3>
        <p id="paragraph-22" class="paragraph">
          <font color="red">COEPの話</font
          ><a href="#paragraph-22" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-23" class="paragraph">
          <a href="https://placehold.jp/300x300.jpg" rel="noopener"
            ><img src="https://placehold.jp/300x300.jpg" /></a
          ><a href="#paragraph-23" class="paragraph-anchor">¶</a>
        </p>
        <h3>
          <a
            name="cross-origin-read-blocking-(corb)--opaque-response-blocking-(orb)"
            href="#cross-origin-read-blocking-(corb)--opaque-response-blocking-(orb)"
            id="cross-origin-read-blocking-(corb)--opaque-response-blocking-(orb)"
          >
            Cross Origin Read Blocking (CORB) / Opaque Response Blocking (ORB)
          </a>
        </h3>
        <p id="paragraph-24" class="paragraph">
          <font color="red">MIME-base のチェックによる信頼性の向上。</font
          ><a href="#paragraph-24" class="paragraph-anchor">¶</a>
        </p>
        <p id="paragraph-25" class="paragraph">
          <a href="https://placehold.jp/300x300.jpg" rel="noopener"
            ><img src="https://placehold.jp/300x300.jpg" /></a
          ><a href="#paragraph-25" class="paragraph-anchor">¶</a>
        </p>
        <h2>
          <a
            name="post-spectre-開発におけるセキュリティ関連のヘッダの設定"
            href="#post-spectre-開発におけるセキュリティ関連のヘッダの設定"
            id="post-spectre-開発におけるセキュリティ関連のヘッダの設定"
          >
            Post-Spectre 開発におけるセキュリティ関連のヘッダの設定
          </a>
        </h2>
        <p id="paragraph-26" class="paragraph">
          これまで紹介してきた Spectre
          以後に開発されたヘッダや仕組みを使うことで、同じメモリに意図しない
          cross-origin のリソースが読み込まれることは回避できるようになった。<a
            href="#paragraph-26"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-27" class="paragraph">
          この節では具体的な設定値を
          <a
            target="_blank"
            rel="noopener"
            href="https://www.w3.org/TR/post-spectre-webdev/"
            >Post-Spectre Web Development</a
          >
          に書いてあるものを参照して概観する。<a
            href="#paragraph-27"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-28" class="paragraph">
          「<a
            target="_blank"
            rel="noopener"
            href="https://www.w3.org/TR/post-spectre-webdev/"
            >Post-Spectre Web Development</a
          >
          」には下記のように分けて考えてヘッダを設定すべきというように解説がある(見分けやすくするために採番)。<a
            href="#paragraph-28"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <ul>
          <li>
            A. サブリソース
            <ul>
              <li>A.1. 静的サブリソース</li>
              <li>
                A.2. 動的サブリソース
                <ul>
                  <li>A.2.1. アプリケーションの内部レスポンス</li>
                  <li>
                    A.2.1 パーソナライズされた cross-origin で使われるリソース
                  </li>
                  <li>A.2.2 cross-origin に no-cors で読み込むリソース</li>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            B. ドキュメント
            <ul>
              <li>B.1. Fully-Isolated なドキュメント</li>
              <li>B.2. cross-origin の window から開かれるドキュメント</li>
              <li>
                B.3. cross-origin の opener から開かれるドキュメント
                <ul>
                  <li>
                    B.3.1 cross-origin のポップアップで開かれるドキュメント
                  </li>
                  <li>
                    B.3.2 cross-origin の frame に読み込まれるドキュメント
                  </li>
                  <li>
                    B.3.3 cross-origin のポップアップと frame
                    の両方をサポートするドキュメント
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
        <p id="paragraph-29" class="paragraph">
          これまでのヘッダの説明を踏まえて順番に見ていく。<a
            href="#paragraph-29"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h3>
          <a name="a-サブリソース" href="#a-サブリソース" id="a-サブリソース">
            A. サブリソース
          </a>
        </h3>
        <p id="paragraph-30" class="paragraph">
          サブリソースには、大きく静的サブリソースと動的サブリソースがある。次節からそれぞれ紹介する。<a
            href="#paragraph-30"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h4>
          <a
            name="a1-静的サブリソース"
            href="#a1-静的サブリソース"
            id="a1-静的サブリソース"
          >
            A.1. 静的サブリソース
          </a>
        </h4>
        <pre><code class="language-http"><span class="hljs-attribute">Access-Control-Allow-Origin</span>: *
<span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: cross-origin
<span class="hljs-attribute">Timing-Allow-Origin</span>: *
<span class="hljs-attribute">Content-Security-Policy</span>: sandbox
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: DENY
</code></pre>
        <h4>
          <a
            name="a2-動的サブリソース"
            href="#a2-動的サブリソース"
            id="a2-動的サブリソース"
          >
            A.2. 動的サブリソース
          </a>
        </h4>
        <p id="paragraph-31" class="paragraph">
          動的サブリソースには、「アプリケーションの内部レスポンス」、「パーソナライズされた
          cross-origin で使われるリソース」、「cross-origin に no-cors
          で読み込むリソース」の 3 つがある。それぞれ紹介する。<a
            href="#paragraph-31"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h5>
          <a
            name="a21-アプリケーションの内部レスポンス"
            href="#a21-アプリケーションの内部レスポンス"
            id="a21-アプリケーションの内部レスポンス"
          >
            A.2.1. アプリケーションの内部レスポンス
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Content-Security-Policy</span>: sandbox
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: DENY
</code></pre>
        <h5>
          <a
            name="a21-パーソナライズされた-cross-origin-で使われるリソース"
            href="#a21-パーソナライズされた-cross-origin-で使われるリソース"
            id="a21-パーソナライズされた-cross-origin-で使われるリソース"
          >
            A.2.1 パーソナライズされた cross-origin で使われるリソース
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Access-Control-Allow-Credentials</span>: true
<span class="hljs-attribute">Access-Control-Allow-Origin</span>: https://trusted.example
<span class="hljs-attribute">Access-Control-Allow-Methods</span>: POST
<span class="hljs-attribute">Access-Control-Allow-Headers</span>: ...
<span class="hljs-attribute">Access-Control-Allow-...</span>: ...
<span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Content-Security-Policy</span>: sandbox
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: DENY
</code></pre>
        <h5>
          <a
            name="a22-cross-origin-に-no-cors-で読み込むリソース"
            href="#a22-cross-origin-に-no-cors-で読み込むリソース"
            id="a22-cross-origin-に-no-cors-で読み込むリソース"
          >
            A.2.2 cross-origin に no-cors で読み込むリソース
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: cross-origin
<span class="hljs-attribute">Content-Security-Policy</span>: sandbox
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: DENY
</code></pre>
        <h3>
          <a name="b-ドキュメント" href="#b-ドキュメント" id="b-ドキュメント">
            B. ドキュメント
          </a>
        </h3>
        <p id="paragraph-32" class="paragraph">
          ドキュメントには「Fully-Isolated なドキュメント」、「cross-origin の
          window から開かれるドキュメント」、「cross-origin の opener
          から開かれるドキュメント」の 3
          種類のケースがある。それぞれ紹介する。<a
            href="#paragraph-32"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h4>
          <a
            name="b1-fully-isolated-なドキュメント"
            href="#b1-fully-isolated-なドキュメント"
            id="b1-fully-isolated-なドキュメント"
          >
            B.1. Fully-Isolated なドキュメント
          </a>
        </h4>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: SAMEORIGIN
</code></pre>
        <h4>
          <a
            name="b2-cross-origin-の-window-から開かれるドキュメント"
            href="#b2-cross-origin-の-window-から開かれるドキュメント"
            id="b2-cross-origin-の-window-から開かれるドキュメント"
          >
            B.2. cross-origin の window から開かれるドキュメント
          </a>
        </h4>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin-allow-popups
<span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: SAMEORIGIN
</code></pre>
        <h4>
          <a
            name="b3-cross-origin-の-opener-から開かれるドキュメント"
            href="#b3-cross-origin-の-opener-から開かれるドキュメント"
            id="b3-cross-origin-の-opener-から開かれるドキュメント"
          >
            B.3. cross-origin の opener から開かれるドキュメント
          </a>
        </h4>
        <p id="paragraph-33" class="paragraph">
          cross-origin の opener
          から開かれるドキュメントとしては、「cross-origin
          のポップアップで開かれるドキュメント」、「cross-origin の frame
          に読み込まれるドキュメント」、「cross-origin のポップアップと frame
          の両方をサポートするドキュメント」の 3
          ケースがある。それぞれ紹介する。<a
            href="#paragraph-33"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h5>
          <a
            name="b31-cross-origin-のポップアップで開かれるドキュメント"
            href="#b31-cross-origin-のポップアップで開かれるドキュメント"
            id="b31-cross-origin-のポップアップで開かれるドキュメント"
          >
            B.3.1 cross-origin のポップアップで開かれるドキュメント
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: unsafe-none
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: SAMEORIGIN
</code></pre>
        <h5>
          <a
            name="b32-cross-origin-の-frame-に読み込まれるドキュメント"
            href="#b32-cross-origin-の-frame-に読み込まれるドキュメント"
            id="b32-cross-origin-の-frame-に読み込まれるドキュメント"
          >
            B.3.2 cross-origin の frame に読み込まれるドキュメント
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: same-origin
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: ALLOWALL
</code></pre>
        <h5>
          <a
            name="b33-cross-origin-のポップアップと-frame-の両方をサポートするドキュメント"
            href="#b33-cross-origin-のポップアップと-frame-の両方をサポートするドキュメント"
            id="b33-cross-origin-のポップアップと-frame-の両方をサポートするドキュメント"
          >
            B.3.3 cross-origin のポップアップと frame
            の両方をサポートするドキュメント
          </a>
        </h5>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-origin
<span class="hljs-attribute">Cross-Origin-Opener-Policy</span>: unsafe-none
<span class="hljs-attribute">Vary</span>: Sec-Fetch-Dest, Sec-Fetch-Mode, Sec-Fetch-Site
<span class="hljs-attribute">X-Content-Type-Options</span>: nosniff
<span class="hljs-attribute">X-Frame-Options</span>: ALLOWALL
</code></pre>
        <h2>
          <a
            name="その他のセキュリティのための取り組み"
            href="#その他のセキュリティのための取り組み"
            id="その他のセキュリティのための取り組み"
          >
            その他のセキュリティのための取り組み
          </a>
        </h2>
        <h3>
          <a
            name="chromeチームによる意思決定"
            href="#chromeチームによる意思決定"
            id="chromeチームによる意思決定"
          >
            Chromeチームによる意思決定
          </a>
        </h3>
        <p id="paragraph-34" class="paragraph">
          開発者たちは、ユーザのデータを守ることと、Web
          の互換性を守ることを考えてどういった対応が必要か検討したようだ。 「<a
            target="_blank"
            rel="noopener"
            href="https://docs.google.com/document/d/1dnUjxfGWnvhQEIyCZb0F2LmCZ9gio6ogu2rhMGqi6gY/edit#heading=h.9ccugcg4ngnq"
            >Long-Term Web Browser Mitigations for Spectre - Google Docs</a
          >」に記載がある。<a href="#paragraph-34" class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-35" class="paragraph">
          <font color="red">ここの記載を熱くする</font
          ><a href="#paragraph-35" class="paragraph-anchor">¶</a>
        </p>
        <h3>
          <a name="credentialless" href="#credentialless" id="credentialless">
            credentialless
          </a>
        </h3>
        <p id="paragraph-36" class="paragraph">
          credentialless という文言を聞いたことがあるかもしれない。
          credentialless
          という名前がついているものは、クロスオリジンのリソースを読み込むときには、Cookie
          など(追加)の credential を送らないようにするものだ。たとえば、iframe
          credentialless がそれにあたる。<a
            href="#paragraph-36"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-37" class="paragraph">
          Cookie
          を利用して取得するリソースはプライベートなリソースの可能性が高い。credentialless
          な要素は意図しないドキュメントにプライベートな情報が読み込まれるのを防ぐことができる。<a
            href="#paragraph-37"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-38" class="paragraph">
          <font color="red">ここの記載を熱くする</font
          ><a href="#paragraph-38" class="paragraph-anchor">¶</a>
        </p>
        <h3>
          <a
            name="デフォルトの挙動をどうするのか"
            href="#デフォルトの挙動をどうするのか"
            id="デフォルトの挙動をどうするのか"
          >
            デフォルトの挙動をどうするのか
          </a>
        </h3>
        <p id="paragraph-39" class="paragraph">
          これまでのヘッダを設定していなければ Spectre
          による攻撃の対象となり得る。設定していなければ<a
            href="#paragraph-39"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-40" class="paragraph">
          Spectre などの同じプロセスのメモリを読み込む攻撃はブラウザベンダと Web
          コミュニティの努力で防ぐ方法が確立しつつある。しかし、依然としてセキュリティ関連のヘッダ設定を済ませていないサイトが多くあるのも事実である。<a
            href="#paragraph-40"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-41" class="paragraph">
          ブラウザがデフォルトの挙動を変更できれば良いのだが、Web
          の互換性を守るためには慎重になる必要があるようだ(もしかしたら実現できないかもしれない)。<a
            href="#paragraph-41"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-42" class="paragraph">
          <font color="red">ここの記載を熱くする</font
          ><a href="#paragraph-42" class="paragraph-anchor">¶</a>
        </p>
        <h2>
          <a name="おわりに" href="#おわりに" id="おわりに"> おわりに </a>
        </h2>
        <p id="paragraph-43" class="paragraph">
          今回、Spectre
          以後に登場したセキュリティ関連のヘッダや仕組みについて紹介した。<a
            href="#paragraph-43"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-44" class="paragraph">
          ブラウザベンダの活躍を待つだけなく、<strong
            >Web
            のコミュニティのそれぞれができることを少しずつでもやっていくとよさそうだ。具体的には、今回のセキュリティヘッダの設定だ</strong
          >。読み込まれるドキュメントやサブリソースにヘッダが設定されることで、意図して共有している/していないのか、あるいは共有していないのかが分かる。リソースオーナーが読み込みを拒否して壊れるサイトがあっても、それは仕方がないと判断できる。<a
            href="#paragraph-44"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-45" class="paragraph">
          セキュリティヘッダの設定が十分に行き渡り、意図せず互換性が崩れるリスクが十分に下がれば、ブラウザのデフォルトの挙動を変更することができる。<strong
            >デフォルトで安全な Web
            の実現はセキュリティヘッダの設定が難しいユーザ層が、安心して Web
            というコミュニティに参加できるようにするためには必要</strong
          >なことのように思う。<a href="#paragraph-45" class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-46" class="paragraph">
          この記事を読んで少し自分のサイトの設定を見直して見るきっかけになればと思っている。<a
            href="#paragraph-46"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <p id="paragraph-47" class="paragraph">
          もしも、誤りや補足の情報があれば
          <a
            target="_blank"
            rel="noopener"
            href="https://github.com/negibokken/bokken.io/issues"
            >issue</a
          >
          や
          <a target="_blank" rel="noopener" href="https://twitter.com/bokken_"
            >@bokken_</a
          >
          までいただけると嬉しい。<a
            href="#paragraph-47"
            class="paragraph-anchor"
            >¶</a
          >
        </p>
        <h2>
          <a name="参考リンク" href="#参考リンク" id="参考リンク">
            参考リンク
          </a>
        </h2>
        <ul>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://www.w3.org/TR/post-spectre-webdev/"
              >Post-Spectre Web Development</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://arturjanc.com/coi-threat-model.pdf"
              >Notes on the threat model of cross-origin isolation</a
            >
          </li>
          <li>
            <a target="_blank" rel="noopener" href="https://web.dev/coop-coep/"
              >Making your website &quot;cross-origin isolated&quot; using COOP
              and COEP</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://docs.google.com/document/d/1zDlfvfTJ_9e8Jdc8ehuV4zMEu9ySMCiTGMS9y0GU92k/edit"
              >COOP and COEP Explained</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://www.chromium.org/developers/design-documents/oop-iframes/"
              >Out-of-Process iframes (OOPIFs)</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://zenn.dev/jxck/books/origin-anatomia"
              >Origin 解体新書</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://blog.agektmr.com/2021/11/browser-security.html"
              >Spectre の脅威とウェブサイトが設定すべきヘッダーについて</a
            >
          </li>
          <li>
            <a
              target="_blank"
              rel="noopener"
              href="https://www.chromium.org/developers/design-documents/oop-iframes/"
              >Out-of-Process iframes (OOPIFs)</a
            >
          </li>
        </ul>
      </article>

      <!-- prettier-ignore -->
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
      <!-- prettier-ignore -->
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script>

      <!-- prettier-ignore -->
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="20" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
      <!-- prettier-ignore -->
      <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async" ></script>

      <div>
        Subscribe via <a href="https://blog.bokken.io/feeds/atom.xml">RSS</a>
      </div>

      <div class="article-pager">
        <div class="prev-article">
          <a
            href="https://blog.bokken.io/articles/2023-09-20/about-post-spectre.html"
          >
            前の記事へ
          </a>
        </div>

        <div class="blog-top">
          <a href="https://blog.bokken.io">TOP</a>
        </div>

        <div class="next-article">
          <a
            href="https://blog.bokken.io/articles/2023-09-20/about-post-spectre.html"
          >
            次の記事へ
          </a>
        </div>
      </div>
    </main>

    <footer>
      Copyright &copy; 2018 bokken. All Rights Reserved.
      <a href="https://bokken.io/privacy-policy.html">Privacy Policy</a>
    </footer>
  </body>
</html>

