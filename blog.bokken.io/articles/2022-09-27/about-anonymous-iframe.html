<!DOCTYPE html>
<html lang="ja">
  <head
    prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#"
  >
    <meta charset="utf-8" />
    <title>Anonymous iframe とは (WIP) | blog.bokken.io</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta
      name="description"
      content="&lt;a href=&#34;https://wicg.github.io/anonymous-iframe/&#34;&gt;Anonymous iframe&lt;/a&gt; という仕様がある。
この仕様が何を問題としていて、何を解決するための仕様なのかをまとめる。"
    />
    <meta name="author" content="bokken" />
    <link rel="shortcut icon" href=/assets/img/favicon.ico />
    <link rel="author" href="humans.txt" />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@bokken_" />
    <meta name="twitter:creator" content="@bokken_" />
    <meta
      name="twitter:image"
      content="https://bokken.io/assets/img/icon.png"
    />
    <!-- ogp -->
    <meta
      property="og:url"
      content="https://blog.bokken.io/articles/2022-09-27/about-anonymous-iframe.html"
    />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Anonymous iframe とは (WIP)" />
    <meta
      property="og:description"
      content="&lt;a href=&#34;https://wicg.github.io/anonymous-iframe/&#34;&gt;Anonymous iframe&lt;/a&gt; という仕様がある。
この仕様が何を問題としていて、何を解決するための仕様なのかをまとめる。"
    />
    <meta property="og:site_name" content="blog.bokken.io" />
    <meta property="og:image" content="https://bokken.io/assets/img/icon.png" />

    <!-- Google -->
    <!-- prettier-ignore -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-83287008-4"></script>
    <!-- prettier-ignore -->
    <script>
      window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-83287008-4');
    </script>

    <!-- Twitter -->
    <script
      async
      src="https://platform.twitter.com/widgets.js"
      charset="utf-8"
    ></script>
    <!-- prettier-ignore -->
    <script>
      !(function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + '://platform.twitter.com/widgets.js'; fjs.parentNode.insertBefore(js, fjs); } })(document, 'script', 'twitter-wjs');
    </script>

    <link rel=stylesheet type=text/css href=/assets/css/main.css>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/default.min.css"
    />
  </head>

  <body>
    <header>
      <a href="http://bokken.io">bokken.io</a>
      <nav>
        <ul>
          <li><a href="https://blog.bokken.io">Blog</a></li>
          <li><a href="https://x.bokken.io">Exp</a></li>
          <li><a href="https://blog.bokken.io/feeds/atom.xml">RSS</a></li>
        </ul>
      </nav>
    </header>

    <ul id="bread">
      <li><a href="https://bokken.io" bokken.io>bokken.io</a></li>
      <li><a href="https://blog.bokken.io">blog</a></li>
      <li>
        <a
          href="https://blog.bokken.io/articles/2022-09-27/about-anonymous-iframe.html"
          >Anonymous iframe とは (WIP)</a
        >
      </li>
    </ul>

    <main>
      <article>
        <div id="blog-info">
          <dt>作成日</dt>
          <dd>2022-09-27</dd>
          <dt>更新日</dt>
          <dd>2022-10-10</dd>
          <dt>author</dt>
          <dd><a href="https://twitter.com/bokken_">@bokken_</a></dd>
          <dt>tag</dt>
          <dd>
            <img
              id="article-tag"
              src="https://blog.bokken.io/assets/img/tag.webp"
              height="20"
            />
            iframe, spec, COEP, CORP
          </dd>
        </div>
        <h1>
          <a
            name="Anonymous iframe とは (WIP)"
            href="#Anonymous iframe とは (WIP)"
            id="Anonymous iframe とは (WIP)"
          >
            Anonymous iframe とは (WIP)
          </a>
        </h1>
        <h2>
          <a name="はじめに" href="#はじめに" id="はじめに"> はじめに </a>
        </h2>
        <p>
          <a href="https://wicg.github.io/anonymous-iframe/"
            >Anonymous iframe</a
          >
          という仕様がある。
          この仕様が何を問題としていて、何を解決するための仕様なのかをまとめる。
        </p>
        <h2>
          <a name="tl;dr" href="#tl;dr" id="tl;dr"> tl;dr </a>
        </h2>
        <p>
          Anonymous iframe は COEP (Cross Origin Embedder Policy) require-corp
          環境下で外部リソースの利用が制限された状態あっても、安全な形で iframe
          を利用するための仕様である。
        </p>
        <p>
          親から iframe でサイトを埋め込もうとすると、iframe 内のサイトにも COEP
          が指定されている必要がある。
        </p>
        <p>
          サードパーティのサイトである場合、COEP
          を指定してもらうことが難しいか、あるいは時間がかかることがある。そのため、自分のサイトで
          COEP を指定しようとしても、サードパーティのサイトを iframe
          で利用したいがために、自分のサイトで COEP
          指定できないことが起こりうる。
        </p>
        <p>
          これを COEP 指定下であっても iframe を利用できるようにするための仕様が
          Anonymous iframe である。
        </p>
        <h2>
          <a
            name="Cross Origin Embedder Policy (COEP)"
            href="#Cross Origin Embedder Policy (COEP)"
            id="Cross Origin Embedder Policy (COEP)"
          >
            Cross Origin Embedder Policy (COEP)
          </a>
        </h2>
        <p>
          COEP については、<a href="https://web.dev/coop-coep/">@agektmr</a>
          さんの<a href="https://web.dev/coop-coep/">このページ</a>が詳しい。
        </p>
        <p>
          要するに Spectre などの CPU
          の脆弱性を突いてプライベートな情報を盗み取るような攻撃に対して、オプトインされた外部リソースの読み込みのみに限定することでリスクを低減するための仕様であるといえる。
        </p>
        <p>
          ここでいう外部リソースは、iframe や
          script、img、ポップアップなどを含んでいる。
        </p>
        <p>
          COEP には、Cross Origin Resource Policy (CORP)
          の理解が欠かせないので紹介する。
        </p>
        <h2>
          <a
            name="Cross Origin Resource Policy (CORP)"
            href="#Cross Origin Resource Policy (CORP)"
            id="Cross Origin Resource Policy (CORP)"
          >
            Cross Origin Resource Policy (CORP)
          </a>
        </h2>
        <p>
          CORP は Resource
          がどこからのリクエストのときに読み込めるかを指定するためのヘッダで、下記のようなヘッダを指定できる機能である。
        </p>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Resource-Policy</span>: same-site | same-origin | cross-origin</code></pre>
        <p>
          それぞれ、same-site のリソースのみ、same-origin
          のリソースのみ、cross-origin でも読み込みができることを表す。
        </p>
        <p>
          CORP ヘッダを指定することで、画像や script
          などのリソースがどこで利用できるのか明示できる。そのため、開発者が意図しないサイトで利用されることを防ぐことができる。
        </p>
        <h2>
          <a name="COEP と CORP" href="#COEP と CORP" id="COEP と CORP">
            COEP と CORP
          </a>
        </h2>
        <p>
          COEP では自身が使用する外部リソースに CORP
          を指定することを要求できる。COEP ヘッダには、unsafe-none
          (デフォルト値) か require-corp (CORP による指定が必要) を指定できる。
        </p>
        <pre><code class="language-http"><span class="hljs-attribute">Cross-Origin-Embedder-Policy</span>: unsafe-none | require-corp</code></pre>
        <p>
          こうすることで、COEP ヘッダが指定されているドキュメントについては CORP
          の制約を満たしたリソースのみが存在していることになる。
        </p>
        <p>
          COEP 指定下でリソースが CORP を指定していなくても、 CORS
          で許可されているリソースであれば、img や script などは下記のように
          <a
            href="https://developer.mozilla.org/en-US/docs/Web/HTML/Attributes/crossorigin"
            >crossorigin attribute</a
          >
          を指定することで、クロスオリジンのリソースであっても読み込みができるようになっている。
        </p>
        <pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://third-party.example.com/image.jpg"</span> <span class="hljs-attr">crossorigin</span>&gt;</span></code></pre>
        <p>(※crossorigin 指定は crossorigin=&quot;anonymous&quot; と同様)</p>
        <h2>
          <a
            name="COEP credentialless"
            href="#COEP credentialless"
            id="COEP credentialless"
          >
            COEP credentialless
          </a>
        </h2>
        <p>
          また同様に COEP credentialless という<a
            href="https://html.spec.whatwg.org/multipage/origin.html#coep"
            >仕様</a
          >が
          <a href="https://chromestatus.com/feature/4918234241302528"
            >Chromium に実装</a
          >されている。(2022年10月10日現在では Chromium
          ベースのブラウザだけで、Safari や Firefox では実装されていない)
        </p>
        <p>
          これはリソースのリクエストについてクレデンシャルを含まないようにすることで、パブリックなリソースしか読み込まないようにするための機能である。そうすることで、たとえ攻撃者がドキュメントの情報を窃取しようとしても表示されている内容はパブリックな情報のみなので攻撃されたときのリスクを下げることができるというものだ。
        </p>
        <h2>
          <a name="iframe" href="#iframe" id="iframe"> iframe </a>
        </h2>
        <p>
          しかし、iframe についてはこういった crossorigin attribute
          による指定や、 COEP credentialless による制限の緩和はできなかった。
        </p>
        <p>
          <a
            href="https://wicg.github.io/anonymous-iframe/#alternatives-coep-credentialless"
            >4.3. Make COEP:credentialless to affect &lt;iframe&gt;</a
          >には下記のようにある。
        </p>
        <blockquote>
          <p>
            Originally, COEP:credentialless scope was meant to include both
            simple subresources like it does today, but also the
            &#60;iframe&#62;. The latter is very different in kind, because this
            is not only about the request’s credentials, but also about every
            storage API usage made later by the document. So it has been
            postponed here.
          </p>
        </blockquote>
        <p>
          要するに、COEP credentialless で iframe が対象外となったのは iframe
          はそれ自身がコンテキストを生成し、iframe 内で Storage API の呼び出しや
          iframe 内での iframe の呼び出しなどもできるという点で img や script
          などとは違った性質を持つためである。 そうした背景から iframe
          でも外部リソースを安全に利用するための仕様が Anonymous iframe である。
        </p>
        <h2>
          <a
            name="Anonymous iframe 詳解"
            href="#Anonymous iframe 詳解"
            id="Anonymous iframe 詳解"
          >
            Anonymous iframe 詳解
          </a>
        </h2>
        <p>
          Anonymous iframe の指定は先述の crossorigin attribute のように
          <code>anonymous</code> attribute を指定するだけだ。
        </p>
        <pre><code class="language-html"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">anonymous</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"https://example.com"</span>&gt;</span></code></pre>
        <p>
          <code>anonymous</code> attribute の指定はその子孫 iframe
          にも継承される。仕様に記載されている図がとてもわかり易いので引用する。
        </p>
        <p>
          <img src="./img/inheritance.png" alt="inheritance of anonymous" />
        </p>
        <p>
          (<a href="https://wicg.github.io/anonymous-iframe/#proposal-whatis"
            >Anonymous iframe</a
          >より引用)
        </p>
        <p>
          iframe 内のドキュメントは下記の定数を参照することで自身が anonymous
          指定された iframe なのかどうかを認識できる。
        </p>
        <pre><code class="language-javascript">widndow.anonymouslyFramed</code></pre>
        <p>
          Anonymous iframe では既存のクレデンシャルや shared storage
          は利用できない。ただし、sandboxed frame と違い blank な状態から
          storage API を使うことや、Cookie の登録は可能だ。クレデンシャルや
          storage の共有は同じ Anonymous iframe
          のページ内に限らるように分離されている。
        </p>
        <h3>
          <a
            name="どのように分離を実現するか"
            href="#どのように分離を実現するか"
            id="どのように分離を実現するか"
          >
            どのように分離を実現するか
          </a>
        </h3>
        <p>
          Anonymous iframe では既存の storage key
          に変更して分離を実現している。通常、
          <a href="https://storage.spec.whatwg.org/#storage-key"
            >storage key は Origin で分離されている</a
          >が、Anonymous iframe では iframe
          のトップレベルのサイトと、トップレベルのサイトごとに持つ nonce
          の組み合わせで storage key
          を区別する。こちらについてもスペックの図がわかりやすいので引用する。
        </p>
        <p>
          <img src="./img/partition-key.png" alt="partition key" /> (<a
            href="https://wicg.github.io/anonymous-iframe/#proposal-credentials"
            >Anonymous iframe</a
          >より引用)
        </p>
        <p>
          nonce はトップレベルサイトごとに決まり、子孫の Anonymous iframe
          に共有される。こうすることで、ある Origin ですでに利用されていた
          storage であっても、Anonymous iframe 以下であれば nonce
          が違うので分離が実現される。
        </p>
        <p>
          また、同一 Origin であっても各 navigate ごとに nonce
          は変わるので、過去に storage を使っていたとしても再利用はできない。
          ただし、back-forward cache を使って restore
          された場合については、storage
          も再利用できるので、これらの挙動には注意が必要だろう。
        </p>
        <p>
          <img
            src="./img/page-change-nonce.png"
            alt="page nonce per navigation"
          />
        </p>
        <h2>
          <a
            name="その他細かなブラウザの挙動"
            href="#その他細かなブラウザの挙動"
            id="その他細かなブラウザの挙動"
          >
            その他細かなブラウザの挙動
          </a>
        </h2>
        <p>
          COEP ヘッダが送られてきたときに Anonymous iframe
          を使って入れば、ブラウザは COEP
          ヘッダをチェックしないようになっている。(もともと COEP ヘッダが iframe
          内のサイトでデプロイされていない課題を解決したかたので当然だが)
        </p>
        <p>
          合わせてパスワードマネージャによるオートフィルも効かないようになる。筆者はパスワードマネージャが表示されるかどうかもフィッシング詐欺サイトではないことの目安にしていたので、パスワードマネージャが表示されないことでユーザに疑念を抱かれる懸念はありそうだ。
        </p>
        <h2>
          <a name="おわりに" href="#おわりに" id="おわりに"> おわりに </a>
        </h2>
        <p>
          今回 Anonymous iframe という COEP ヘッダ (require-corp)
          指定下で、iframe が動かない問題を解決するための仕様をまとめた。
        </p>
        <p>
          このまとめを通して、安全に分離を実現するためにはどのように考えるべきなのかを知れた。このまとめを通して気になった点も今後まとめていきたい。
        </p>
        <p>
          もし、何かしら間違いやコメントがあった場合、<a
            href="https://github.com/negibokken/bokken.io/issues"
            >issue</a
          >
          か
          <a href="https://twitter.com/bokken_">@bokken_</a>
          までもらえると嬉しい。
        </p>
        <h2>
          <a name="参考" href="#参考" id="参考"> 参考 </a>
        </h2>
        <ol>
          <li>
            <a href="https://wicg.github.io/anonymous-iframe/"
              >Anonymous iframe</a
            >
          </li>
          <li>
            <a href="https://web.dev/coop-coep/"
              >Making your website &quot;cross-origin isolated&quot; using COOP
              and COEP</a
            >
          </li>
          <li>
            <a href="https://web.dev/why-coop-coep/"
              >Why you need &quot;cross-origin isolated&quot; for powerful
              features</a
            >
          </li>
          <li>
            <a
              href="https://html.spec.whatwg.org/multipage/iframe-embed-object.html#attr-iframe-sandbox"
              >sandbox attribute | HTML Standard</a
            >
          </li>
          <li>
            <a
              href="https://chromium.googlesource.com/chromium/src/+/master/docs/security/side-channel-threat-model.md"
              >Chromium Docs - Post-Spectre Threat Model Re-Think</a
            >
          </li>
          <li>
            <a href="https://wicg.github.io/cross-origin-embedder-policy/"
              >Cross-Origin Embedder Policy</a
            >
          </li>
        </ol>
      </article>

      <!-- prettier-ignore -->
      <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
      <!-- prettier-ignore -->
      <script async src="https://platform.twitter.com/widgets.js" charset="utf-8" ></script>

      <!-- prettier-ignore -->
      <a href="https://b.hatena.ne.jp/entry/" class="hatena-bookmark-button" data-hatena-bookmark-layout="basic-label" data-hatena-bookmark-lang="ja" data-hatena-bookmark-height="20" title="このエントリーをはてなブックマークに追加"><img src="https://b.st-hatena.com/images/v4/public/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
      <!-- prettier-ignore -->
      <script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async" ></script>

      <div>
        Subscribe via <a href="https://blog.bokken.io/feeds/atom.xml">RSS</a>
      </div>

      <div class="article-pager">
        <div class="prev-article">
          <a
            href="https://blog.bokken.io/articles/2022-08-31/chromium-commits.html"
          >
            前の記事へ
          </a>
        </div>

        <div class="blog-top">
          <a href="https://blog.bokken.io">TOP</a>
        </div>
      </div>
    </main>

    <footer>
      Copyright &copy; 2018 bokken. All Rights Reserved.
      <a href="https://bokken.io/privacy-policy.html">Privacy Policy</a>
    </footer>
  </body>
</html>

